name: ğŸš€ íŒœëœë”© í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬

# íŠ¸ë¦¬ê±°: main ë¸Œëœì¹˜ì— push ì‹œ ì‹¤í–‰
on:
  push:
    branches:
      - main
  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
  workflow_dispatch:

jobs:
  build_and_deploy:
    name: ğŸ—ï¸ ë¹Œë“œ ë° ë°°í¬
    runs-on: ubuntu-latest
    
    steps:
      # 1ï¸âƒ£ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸° (optional)

      # 2ï¸âƒ£ Node.js í™˜ê²½ ì„¤ì •
      - name: ğŸŸ¢ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ secrets.NODE_VERSION }}
          cache: 'npm'  # npm ìºì‹œ í™œìš©ìœ¼ë¡œ ë¹Œë“œ ì†ë„ í–¥ìƒ

      # 3ï¸âƒ£ ì˜ì¡´ì„± ì„¤ì¹˜
      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          npm ci
          echo "âœ… ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"

      # 5ï¸âƒ£ ë¹Œë“œ ì‹¤í–‰
      - name: ğŸ—ï¸ í”„ë¡œì íŠ¸ ë¹Œë“œ
        run: |
          npm run build
          echo "âœ… ë¹Œë“œ ì™„ë£Œ"
          echo "ğŸ“‚ ë¹Œë“œ ì¶œë ¥ ë””ë ‰í† ë¦¬ ë‚´ìš©:"
          ls -la dist/

      # 6ï¸âƒ£ AWS ìê²© ì¦ëª… ì„¤ì •
      - name: ğŸ” AWS ìê²© ì¦ëª… ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 7ï¸âƒ£ S3ì— íŒŒì¼ ì—…ë¡œë“œ
      - name: ğŸ“¤ S3ì— ë¹Œë“œ íŒŒì¼ ì—…ë¡œë“œ
        run: |
          echo "ğŸš€ S3 ì—…ë¡œë“œ ì‹œì‘..."
          
          # HTML íŒŒì¼ì€ ì§§ì€ ìºì‹œ (ì¦‰ì‹œ ì—…ë°ì´íŠ¸)
          aws s3 cp dist/index.html s3://${{ secrets.S3_BUCKET }}/index.html \
            --content-type "text/html" \
            --cache-control "max-age=0, no-cache, no-store, must-revalidate" \
            --metadata-directive REPLACE
          
          # ì •ì  ìì‚°ì€ ê¸´ ìºì‹œ (CSS, JS, ì´ë¯¸ì§€ ë“±)
          aws s3 sync dist/ s3://${{ secrets.S3_BUCKET }}/ \
            --delete \
            --cache-control "max-age=31536000, public, immutable" \
            --exclude "index.html" \
            --size-only
          
          echo "âœ… S3 ì—…ë¡œë“œ ì™„ë£Œ"

      # 8ï¸âƒ£ CloudFront ìºì‹œ ë¬´íš¨í™”
      - name: ğŸ”„ CloudFront ìºì‹œ ë¬´íš¨í™”
        run: |
          echo "ğŸ”„ CloudFront ìºì‹œ ë¬´íš¨í™” ì‹œì‘..."
          
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)
          
          echo "ë¬´íš¨í™” ID: $INVALIDATION_ID"
          echo "âœ… CloudFront ìºì‹œ ë¬´íš¨í™” ìš”ì²­ ì™„ë£Œ"
          echo "ğŸ“ ë°°í¬ê°€ ì™„ì „íˆ ë°˜ì˜ë˜ë ¤ë©´ 1-3ë¶„ ì •ë„ ì†Œìš”ë©ë‹ˆë‹¤."

      # 9ï¸âƒ£ ë°°í¬ ì™„ë£Œ ì•Œë¦¼
      - name: ğŸ‰ ë°°í¬ ì™„ë£Œ
        run: |
          echo "ğŸ‰ íŒœëœë”© í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ğŸŒ ì›¹ì‚¬ì´íŠ¸: https://íŒœëœë”©.net"
          echo "ğŸ“… ë°°í¬ ì‹œê°„: $(date)"
